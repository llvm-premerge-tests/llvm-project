#===----------------------------------------------------------------------===##
#
# Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
#
#===----------------------------------------------------------------------===##

#
# This file describes the various pre-commit CI bots used to test libc++.
#
# This file should never contain logic -- all the logic must be offloaded
# into scripts. This is critical to being able to reproduce CI issues outside
# of the CI environment, which is important for debugging.
#
# It is also worth noting that this script is split into several sections, the
# goal being to reduce the load on testers when a commit is known to fail.
#

# The Linux CI runners use the nightly ToT build provided by the Docker image.
# (Note the image isn't updated daily.) The LLVM_HEAD_VERSION contains that
# version number. The Linux CI runners for GCC use the latest stable version.
# Theses numbers are available in all runners, making it easier to update the
# version number.
env:
    # LLVM POST-BRANCH bump version
    # LLVM POST-BRANCH add compiler test for ToT - 1, e.g. "Clang 17"
    # LLVM RELEASE bump remove compiler ToT - 3, e.g. "Clang 15"
    LLVM_STABLE_VERSION: "16" # Used for tooling, update after the RELEASE.
    LLVM_HEAD_VERSION: "18"   # Used compiler, update POST-BRANCH.
    GCC_STABLE_VERSION: "13"
steps:
  #
  # Light pre-commit tests for things like forgetting to update generated files.
  #
  - group: ":mac: Apple"
    steps:
    - label: "MacOS x86_64"
      command: "libcxx/utils/ci/run-buildbot generic-cxx23"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "x86_64"
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    - label: "MacOS arm64"
      command: "libcxx/utils/ci/run-buildbot generic-cxx23"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "arm64"
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    - label: "MacOS with Modules"
      command: "libcxx/utils/ci/run-buildbot generic-modules"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    # Build with the configuration we use to generate libc++.dylib on Apple platforms
    - label: "Apple system"
      command: "libcxx/utils/ci/run-buildbot apple-system"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "arm64" # This can technically run on any architecture, but we have more resources on arm64 so we pin this job to arm64
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    # Test back-deployment to older Apple platforms
    - label: "Apple back-deployment macosx10.13"
      command: "libcxx/utils/ci/run-buildbot apple-system-backdeployment-10.13"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "x86_64" # We need to use x86_64 for back-deployment CI on this target since macOS didn't support arm64 back then.
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    - label: "Apple back-deployment macosx10.15"
      command: "libcxx/utils/ci/run-buildbot apple-system-backdeployment-10.15"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "x86_64" # We need to use x86_64 for back-deployment CI on this target since macOS didn't support arm64 back then.
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120

    # TODO: Re-enable this once we've figured out how to run back-deployment testing on arm64 on recent OSes
    # - label: "Apple back-deployment macosx11.0 arm64"
    #   command: "libcxx/utils/ci/run-buildbot apple-system-backdeployment-11.0"
    #   artifact_paths:
    #     - "**/test-results.xml"
    #     - "**/*.abilist"
    #   agents:
    #     queue: "libcxx-builders"
    #     os: "macos"
    #     arch: "arm64"
    #   retry:
    #     automatic:
    #       - exit_status: -1  # Agent was lost
    #         limit: 2
    #   timeout_in_minutes: 120

    - label: "Apple back-deployment with hardening enabled"
      command: "libcxx/utils/ci/run-buildbot apple-system-backdeployment-hardened-11.0"
      artifact_paths:
        - "**/test-results.xml"
        - "**/*.abilist"
      agents:
        queue: "libcxx-builders"
        os: "macos"
        arch: "x86_64" # TODO: Remove this once we are able to run back-deployment on arm64 again, since this isn't x86_64 specific
      retry:
        automatic:
          - exit_status: -1  # Agent was lost
            limit: 2
      timeout_in_minutes: 120
