

## CMake for MDL-LLVM integration


#### **Overview:**

Modify LLVM’s CMake  files to support the use of the MDL compiler in the building of clang.  The use of the MDL is optional.  It currently supports architectures that use SchedModels and/or Itineraries to implement instruction scheduling. The model we currently want to support is to automatically generate the MDL file from tablegen information, then use the MDL compiler output as part of the build.  Later, we will want to support the hand-writing of MDL files, so at that point the process will change.

Note that there are no new libraries introduced by this change.  We’re adding a few new source files to CodeGen, and we’re generating code which is included by existing CodeGen and MC source files (much like TableGen generated files).

Applies to architectures that do instruction scheduling:



*   AArch64, AMDGPU, ARM, Hexagon, Lanai, Mips, PowerPC, RISCV Sparc, SystemZ, X86

All other targets don’t define an architecture spec, so there’s no need to use MDL:



*   ARC, AVR, BPF, CSKY, LoongArch, M68k, MSP430, NVPTX, VE, WebAssembly, XCore


#### **CMake Configuration:**

We’ve added a CMake variable that controls whether the MDL infrastructure is included in the LLVM build: LLVM\_ENABLE\_MDL.   It is OFF by default.  Setting it to ON will modify the build process to use the TdScan and MdlCompiler utilities to create and compile MDL descriptions of each target architecture, and include the generated code in the MC library.


#### **Required Tools:**

Antlr4: 

You need the Antlr4 tool to build the MDL compiler.  You can download the complete jar file at: https://www.antlr.org/download.html, at least version 4.10. Copy the file to /usr/local/lib.

Python:

You need python to run Antlr: sudo apt-get install python.


#### **Details:**

We’ve added two new utilities to llvm that work with TableGen output files to produce code which is used in Codegen and MC libraries.  The two utilities are:



*   **utils/TdScan** - This scrapes architecture information from a target’s tablegen files and produces two “mdl” files that uses our MDL language to describe the architecture.
*   **utils/MdlCompiler** - a compiler for the MDL language that reads a .mdl file and produces C source code that is #included by Target and MC libraries.

To summarize the modification of the build process:



1. We instruct TableGen to produce a “_$TARGET_.txt” file, using the –print\_records flag.
2. We use tdscan to read the generated “$TARGET.txt” and produce two files:
    1. _ “$TARGET_.mdl”: contains microarchitecture information
    2. “_$TARGET_\_instructions.mdl”: contains register, operand, and instruction information - used to sync the MDL description with the LLVM description.  This file is imported into _$TARGET_.mdl.
3. We use mdl to compile the _$TARGET_.mdl” file into 3 “.inc” files which are included in Target and MC library source code (much like the output of tablegen.)
    3. _$TARGET_GenMdlInfo.inc
    4. _$TARGET_GenMdlTarget.inc
    5. _$TARGET_GenMdlInfo.h

    These should be generated and moved to the same directory as the tablegen output files.


We added five new C++ source files:



1. llvm/include/llvm/CodeGen/MDLBundle.h
2. llvm/include/llvm/MDLHazardRecognizer.h
3. llvm/include/llvm/MC/MDLInstrInfo.h
4. llvm/include/llvm/MC/MDLInfo.h
5. llvm/lib/MC/MDLInstrInfo.cpp

There are a few new dependencies for LLVM:



1. The tdscan step is dependent on the target’s tablegen records.txt files (and on the tdscan utility)
2. The mdl compilation step is dependent on the file produced by tdscan (and on the mdl utility)
3. The Target and MC library sources are dependent on the three files generated by the MDL compiler:
    1. llvm/lib/Target/\*/\*Subtarget.cpp:
        *   #includes _$TARGET_GenMdlInfo.inc
        *   #includes _$TARGET_GenMdlTarget.inc
    2. llvm/lib/Target/\*/\*MCTargetDesc.cpp
        *   #includes _$TARGET_GenMdlInfo.\* 
4. New header file dependencies:
    3. MDLInstrInfo.h: used by
        *   lib/CodeGen/TargetSchedule.cpp
        *   lib/MC/MCSchedule.cp
        *   include/llvm/CodeGen/MDLBundle.h
    4. MDLInfo.h: used by
        *   lib/CodeGen/TargetSchedule.cpp
        *   lib/CodeGen/TargetSubtargetInfo.cpp
        *   include/llvm/MC/MdlInstrInfo.h
        *   include/llvm/CodeGen/TargetSubtargetInfo.h
        *   include/LLVM/MC/MCSubtargetInfo.h
    5. MDLBundle.h: used by
        *   lib/CodeGen/MDLBundle.cpp
    6. MDLHazardRecognizer.h: used by
        *   llvm/include/llvm/CodeGen/DFAPacketizer.h
        *   llvm/lib/CodeGen/DFAPacketizer.cpp
        *   llvm/lib/CodeGen/TargetInstrInfo.cpp


#### Note on the use of ANTLR

The MDL compiler uses Antlr4 to produce a parser and lexer for the MDL language. The runtime used by the generated parser uses RTTI, which is normally eschewed by LLVM.  However, the MDL compiler itself, and the generated parser itself, do not use RTTI.

However, to correctly link the MDL compiler, generated parser/lexer, and Antlr runtime, we need to compile the MDL compiler with -rtti enabled.  And because of that, we need to compile a few items that we depend on from the llvmSupport library with RTTI as well:



*   CommandLine.cpp
*   FormatVariadic.cpp
*   Error.cpp

We simply include these files directly in the MDL compiler CMake, and compile them with RTTI flags.  It would be great if we could figure out a way to do this more cleanly.  
