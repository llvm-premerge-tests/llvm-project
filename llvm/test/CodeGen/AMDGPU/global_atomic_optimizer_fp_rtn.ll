; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN:  opt -S -mtriple=amdgcn-- -mcpu=gfx906  -amdgpu-atomic-optimizer-strategy=Iterative -passes='amdgpu-atomic-optimizer,verify<domtree>' %s | FileCheck -check-prefix=IR-ITERATIVE %s
; RUN:  opt -S -mtriple=amdgcn-- -mcpu=gfx906 -amdgpu-atomic-optimizer-strategy=DPP -passes='amdgpu-atomic-optimizer,verify<domtree>' %s | FileCheck -check-prefix=IR-DPP %s

declare float @foo(i32)
declare i32 @llvm.amdgcn.workitem.id.x()

define float @global_atomic_fadd_uni_value_scope_agent(ptr addrspace(1) %ptr) #0 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_uni_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_uni_value_scope_agent(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float 4.0 syncscope("agent") monotonic, align 4
  ret float %result
}

define float @global_atomic_fadd_div_value_scope_agent(ptr addrspace(1) %ptr) #0 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_div_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_div_value_scope_agent(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float %divValue syncscope("agent") monotonic, align 4
  ret float %result
}

define float @global_atomic_fadd_uni_value_scope_one_as(ptr addrspace(1) %ptr) #1 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_uni_value_scope_one_as(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("one-as") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_uni_value_scope_one_as(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("one-as") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float 4.0 syncscope("one-as") monotonic
  ret float %result
}


define float @global_atomic_fadd_div_value_scope_one_as(ptr addrspace(1) %ptr) #1 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_div_value_scope_one_as(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("one-as") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_div_value_scope_one_as(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("one-as") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float %divValue syncscope("one-as") monotonic
  ret float %result
}

define float @global_atomic_fsub_uni_value_scope_agent(ptr addrspace(1) %ptr) #2 {
; IR-ITERATIVE-LABEL: @global_atomic_fsub_uni_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fsub_uni_value_scope_agent(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float 4.0 syncscope("agent") monotonic
  ret float %result
}


define float @global_atomic_fsub_div_value_scope_agent(ptr addrspace(1) %ptr) #2 {
; IR-ITERATIVE-LABEL: @global_atomic_fsub_div_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fsub ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fsub_div_value_scope_agent(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fsub ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fsub ptr addrspace(1) %ptr, float %divValue syncscope("agent") monotonic
  ret float %result
}

define float @global_atomic_fmin_uni_value_scope_agent(ptr addrspace(1) %ptr) #0 {
; IR-ITERATIVE-LABEL: @global_atomic_fmin_uni_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fmin ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fmin_uni_value_scope_agent(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fmin ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fmin ptr addrspace(1) %ptr, float 4.0 syncscope("agent") monotonic
  ret float %result
}

define float @global_atomic_fmin_div_value_scope_agent(ptr addrspace(1) %ptr) #0 {
; IR-ITERATIVE-LABEL: @global_atomic_fmin_div_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fmin ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fmin_div_value_scope_agent(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fmin ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fmin ptr addrspace(1) %ptr, float %divValue syncscope("agent") monotonic
  ret float %result
}

define float @global_atomic_fmax_uni_value_scope_agent(ptr addrspace(1) %ptr) #1{
; IR-ITERATIVE-LABEL: @global_atomic_fmax_uni_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fmax ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fmax_uni_value_scope_agent(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fmax ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fmax ptr addrspace(1) %ptr, float 4.0 syncscope("agent") monotonic
  ret float %result
}

define float @global_atomic_fmax_div_value_scope_agent(ptr addrspace(1) %ptr) #1{
; IR-ITERATIVE-LABEL: @global_atomic_fmax_div_value_scope_agent(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fmax ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fmax_div_value_scope_agent(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fmax ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] syncscope("agent") monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fmax ptr addrspace(1) %ptr, float %divValue syncscope("agent") monotonic
  ret float %result
}

define float @global_atomic_fadd_uni_value_scope_defalut(ptr addrspace(1) %ptr) #2 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_uni_value_scope_defalut(
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_uni_value_scope_defalut(
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float 4.000000e+00 monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float 4.0 monotonic, align 4
  ret float %result
}

define float @global_atomic_fadd_div_value_scope_defalut(ptr addrspace(1) %ptr) #2 {
; IR-ITERATIVE-LABEL: @global_atomic_fadd_div_value_scope_defalut(
; IR-ITERATIVE-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-ITERATIVE-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-ITERATIVE-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] monotonic, align 4
; IR-ITERATIVE-NEXT:    ret float [[RESULT]]
;
; IR-DPP-LABEL: @global_atomic_fadd_div_value_scope_defalut(
; IR-DPP-NEXT:    [[ID_X:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; IR-DPP-NEXT:    [[DIVVALUE:%.*]] = call float @foo(i32 [[ID_X]])
; IR-DPP-NEXT:    [[RESULT:%.*]] = atomicrmw fadd ptr addrspace(1) [[PTR:%.*]], float [[DIVVALUE]] monotonic, align 4
; IR-DPP-NEXT:    ret float [[RESULT]]
;
  %id.x = call i32 @llvm.amdgcn.workitem.id.x()
  %divValue = call float @foo(i32 %id.x)
  %result = atomicrmw fadd ptr addrspace(1) %ptr, float %divValue monotonic, align 4
  ret float %result
}


attributes #0 = { "denormal-fp-math-f32"="preserve-sign,preserve-sign" "amdgpu-unsafe-fp-atomics"="true" }
attributes #1 = { strictfp "denormal-fp-math-f32"="preserve-sign,preserve-sign" "amdgpu-unsafe-fp-atomics"="true" }
attributes #2 = { strictfp}
